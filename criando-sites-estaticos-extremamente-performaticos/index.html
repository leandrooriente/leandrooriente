<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8"><title>Criando sites estáticos extremamente performáticos</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/favicons/manifest.json"><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="/favicons/favicon.ico"><meta name="msapplication-config" content="/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="alternate" type="application/atom+xml" title="Atom feed" href="https://leandrooriente.com/rss2.xml"><meta property="fb:pages" content="235902153193497"><link rel="canonical" href="https://leandrooriente.com/criando-sites-estaticos-extremamente-performaticos/"><link rel="stylesheet" href="/css/style.css?v=2472016037"></head></html><body itemscope itemtype="http://schema.org/Blog"><header id="header" itemprop="headline"><div class="inner"><p id="logo"><a href="/">Oriente <span>Desenvolvedor Front End</span></a></p><ul id="social"><li><a href="https://github.com/leandrooriente/"><svg viewbox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"></path></svg></a></li><li><a href="https://www.linkedin.com/in/leandrooriente"><svg viewbox="0 0 512 512"><path d="M186.4 142.4c0 19-15.3 34.5-34.2 34.5 -18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5C171.1 107.9 186.4 123.4 186.4 142.4zM181.4 201.3h-57.8V388.1h57.8V201.3zM273.8 201.3h-55.4V388.1h55.4c0 0 0-69.3 0-98 0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9 0 26.9 0 98 0 98h57.5c0 0 0-68.2 0-118.3 0-50-28.3-74.2-68-74.2 -39.6 0-56.3 30.9-56.3 30.9v-25.2H273.8z"></path></svg></a></li><li><a href="/rss2.xml"><svg viewbox="0 0 512 512"><path d="M201.8 347.2c0 20.3-16.5 36.8-36.8 36.8 -20.3 0-36.8-16.5-36.8-36.8s16.5-36.8 36.8-36.8C185.3 310.4 201.8 326.8 201.8 347.2zM128.2 204.7v54.5c68.5 0.7 124 56.3 124.7 124.7h54.5C306.7 285.3 226.9 205.4 128.2 204.7zM128.2 166.6c57.9 0.3 112.3 22.9 153.2 63.9 41 41 63.7 95.5 63.9 153.5h54.5c-0.3-149.9-121.7-271.4-271.6-271.9V166.6L128.2 166.6z"></path></svg></a></li></ul></div></header><section id="main"><article id="post-criando-sites-estaticos-extremamente-performaticos" class="article" itemscope itemtype="http://schema.org/BlogPosting"><div class="inner"><header class="article-header" itemprop="headline"><h1 class="article-title" itemprop="name">Criando sites estáticos extremamente performáticos</h1><time class="date" itemprop="datePublished" datetime="2016-08-24T01:18:30.000Z">23/08/2016</time></header><div class="article-entry" itemprop="articleBody"><p>Faz tanto tempo que não escrevo aqui no blog que nem sei por onde começar. Então resolvi começar explicando que não sei por onde começar. Me pareceu uma boa introdução.</p><p>Antes de voltar a postar, resolvi dar uma geral no site, até porque o Jekyll (gerador de estáticos que usava) subiu o major para a versão 3 e obviamente me quebrou completamente.</p><p>Pesquisei mais sobre o Jekyll e geradores de sites estáticos para ver o que tinha de novidade e acabei me deparando com uma dúzia de serviços novos.</p><p>Optei pelo Hexo por ser desenvolvido com JavaScript. Tinha alguns problemas quando precisava de algo mais profundo no Jekyll porque não tenho muita familiaridade com Ruby.</p><p>Antes de continuar, vamos aos números porque sou ansioso e não quero esperar até o final do post para cita-los.</p><p><strong>Cenário</strong></p><ul><li>Conexão: 1,5mbps (fazendo throttling no Chrome)</li><li>Post: <a href="https://leandrooriente.com/como-me-tornar-um-desenvolvedor-front-end/">Como me tornar um desenvolvedor Front End</a></li></ul><p><strong>Resultados</strong></p><ul><li>Home sem cache: ~ 650ms load, 500ms first view</li><li>Home com cache: ~ 550ms load, 440ms first view</li><li>Post sem cache: ~ 1,8s load, 1s first view</li><li>Post com cache: ~ 1,2s load, 460ms first view</li></ul><p>Obs: Existem algumas camadas de cache do Disqus, Google Analytics e DNS que fogem do meu controle. É provavel que esses números variem um pouco de acordo com o usuário, seu device e sua posição geográfica, mas serviu como base para validar se as coisas estavam indo bem ou mal a cada ajuste.</p><p>A partir daqui vou separar o post em duas partes: otimizações client site e server side.</p><h2 id="Otimizacoes-client-side"><a href="#Otimizacoes-client-side" class="headerlink" title="Otimizações client side"></a>Otimizações client side</h2><p>A primeira coisa que fiz foi olhar o site e analisar o que realmente importava para o usuário. Tive muita empatia nesse ponto e prestei atenção em quais dados eram realmente relevantes nos posts que acessava.</p><p>Seguindo esse <em>mindset</em> cheguei a algumas conclusões:</p><ul><li><p><strong>Imagem de destaque:</strong> O usuário não se importa com a imagem decorativa da chamada do seu post. Se ela não agrega nenhum valor e está ali simplesmente por firula, remova. Geralmente pesam por baixo uns 100kb e não trazem nenhum valor. O jQuery gzipado pesa uns 80kb, então pensem muito nas imagens.</p></li><li><p><strong>Newsletter:</strong> Tinha uma chamada para cadastro de newsletter, mas não tenho tempo para escrever posts, imagina enviar emails? Adeus Mailchimp.</p></li><li><p><strong>Social Widgets:</strong> Não lembro quando foi a última vez que compartilhei um post usando um widget desses. Se gosto do post, copio a URL e compartilho onde quer que seja. No último ano, por exemplo, compartilhei muito mais conteúdo no Slack e no Whatsapp do que em redes sociais propriamente ditas. Removi todos.</p></li><li><p><strong>Minificação dos assets:</strong> Depois de duas palestras por mês sobre performance nos últímos 5 anos todo mundo sabe que tem que minificar o CSS, JS, HTML e imagens né?</p></li><li><p><strong>Concatenação dos arquivos:</strong> Sprites, main.min.js, libs.min.js? Não. Tocarei com carinho nesse assunto quando falar de HTTP/2</p></li><li><p><strong>HTML otimizado:</strong> Aqui entra uma regra de ouro. Evite poluir o seu DOM. Pense semânticamente em cada elemento que insere no HTML. Quanto menos elementos desnecessários mais rápido para baixar e menos processamento necessário para o seu usuário. Nem todo mundo tem um iPhone 6s no bolso. Pense na galera do Moto E.</p></li><li><p><strong>Ícones:</strong> Usei poucos ícones então resolvi economizar no FontAwesome também. Peguei os 3 que precisava em SVG e adicionei no site.</p></li><li><p><strong>Frameworks:</strong> Não vi necessidade, não usei. Meu CSS ficou com 2.3kb e consegui o resultado que queria. Obviamente meu escopo é mega limitado. Uma lista e uma página de texto, mas sempre pense se realmente precisa de um framework e caso precise, se precisa dele inteiro.</p></li><li><p><strong>Fontes:</strong> Assunto polêmico. Vai ficar pequeno pra essa lista então vamos ao próximo parágrafo.</p></li></ul><p>A equipe de Design da VTEX pirava comigo (pirava porque sai de lá, mas é assunto pra outro post). Sou um teste de acessibilidade ambulante. Tenho um problema grave de córnea e daltonismo (grau baixo, sei qual semáforo é o vermelho e não uso amarelo com azul) então se eu conseguisse ler bem e entender a mensagem que queriam passar era porque estava tudo ok.</p><p>Por conta disso sempre valorizei boas interfaces para leitura. Bati palmas de pé e chorando quando o Medium foi lançado. Era essa a experiência de leitura que a internet precisava e ninguém entregava. Muitos sites evoluiram sua tipografia e atenção à formatação do conteúdo depois que o Medium chegou com uma voadora de dois pés na web.</p><p>Então esse era um ponto que não podia pecar. Se eu não passasse no meu teste de acessibilidade era sinal de que o site estava ruim.</p><p>E chegou o momento da fanfarronice. Entro no Google Fonts como se fosse um Walmart e vou selecionando. Proxima Nova, me vê uma 400, 500 e 700. Ah, não esqueça do itálico. Quero uma Arvo também, mas essa pode ser só bold porque vou usar nos títulos, hum… desce itálico também porque vai que quero ser irônico né?</p><p>O Google Fonts já deu a deixa. Avisou que vai ficar lento, mas cara, não tem como criar sites usando Arial e Times New Roman. Bota 250kb pra dentro e vida que segue.</p><p>Não me pareceu bom. Estava economizando 80kb de jQuery aqui, 60kb de framework lá, 100kb de imagem ali, mas jogando 250kb de fontes no site cujo conteúdo em si pesa uns 4kb?</p><p>Algumas horas de pesquisa até achar <a href="https://www.smashingmagazine.com/2015/11/using-system-ui-fonts-practical-guide/" target="_blank" rel="external">um post</a> que diz o óbvio. Use a fonte que o device do seu usuário utiliza! Ele já passa o dia todo lendo as interfaces com essa fonte. Seja num Mac, no Windows, no Android, IOS, torradeira, ele já tem um padrão de fontes que está acostumado a ler.</p><p>Bastava achar os principais OS e usar suas fontes. Fiz o teste, olhei no Mac OS, olhei no IOS, olhei no Android, me pareceu bom. Pronto, formatação descente sem um 1kb a mais por isso.</p><p>Quer experiência mais deprimente que acessar um site, ver ele carregar inteirinho e ficar olhando aquele clarão na área do conteúdo porque a bendita fonte ainda não veio? Me entrega o site em HTML puro, mas não me faz esperar a única coisa que realmente importa.</p><p>Funcionou pra mim. Não sou a Globo.com, nem a Coca Cola. É óbvio que não são todos os casos em que você pode se dar ao luxo de não usar determinada fonte. Mas, esteja aberto a novas experiências 😏.</p><p>Fim do primeiro tempo. Resumo geral. Minha home ficou com 16kb contando com o Google Analytics que pesa 11kb (alô google, vamos enxugar isso ai).</p><h2 id="Otimizacoes-server-side"><a href="#Otimizacoes-server-side" class="headerlink" title="Otimizações server side"></a>Otimizações server side</h2><p>Certo, o site já tinha tudo para carregar rápido. Estou usando o Hexo, então basicamente o que tenho no final das contas são pastas e arquivos estáticos. Se jogasse no UOL Host já ia entregar numa velocidade descente (eu acho), não precisa processar nada, só entregar o arquivo.</p><p>Mas eu precisava ir além. <em>We need to go deeper</em>.</p><p>Uso Digital Ocean tem alguns anos e sempre fiz o básico lá. Peguei um tutorial do NGINX para Ubuntu e coloquei o site no ar. E assim permaneceu por uns bons 3 ou 4 anos.</p><p>Só que comecei a lidar um pouco com infra na VTEX, a ler mais a respeito e vi que podia otimizar o meu site. Melhorei praticamente tudo que podia otimizar sem gastar mais do que o custo do próprio server.</p><h3 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP/2"></a>HTTP/2</h3><p>Uma das regras de ouro para performance web era minificar e concatenar de forma inteligente tudo o que você pudesse para reduzir a quantidade de requests do browser.</p><p>No HTTP 1.1 o browser enfilera os seus requests até determinado ponto e depois vai entregando conforme a fila vai esvaziando. Abra a aba de network do Chrome e carreguem o site da <a href="http://www.casaevideo.com.br/webapp/wcs/stores/servlet/pt/auroraesite" target="_blank" rel="external">Casa &amp; Vídeo</a> por exemplo. Analisem como os requests se comportam.</p><p>Se você lida com uma aplicação grande é fácil chegar nos 60, 80 requests por página. E nesse ponto a infra começa a ficar cara. Ai entram os Sprites de imagem, arquivos gigantes concatenados, CDN’s e etc. para tentar amenizar esse problema.</p><p>No HTTP/2 a magia é outra. Resumidamente, ele cria uma conexão única e transfere uma tonelada de arquivos simultâneamente. Isso fica restrito a cada host obviamente o que de certa forma, remove uma dos maiores benefícios de usar uma CDN, ampliar os requests simultâneos. Se você usava uma CDN somente para isso, pode cancelar e economizar seu dinheiro.</p><p>Mas, nem tudo são flores e para utilizar o HTTP/2 você precisa que seu site tráfegue apenas com SSL (https). E todo mundo sabe que um certificado SSL não é a coisa mais barata do mundo.</p><p>Mas, a comunidade nunca falha e surgiu a iniciativa do <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a> que permite que você gere certificados SSL válidos de graça. Site seguro, rápido e de graça. Quero mais nada da vida.</p><p><strong>Duas observações:</strong></p><ul><li><p>O Google mudou o protocolo de <em>handshaking</em> (processo que valida se as duas pontas estão realmente seguras) para ALPN e essa tecnologia depende do OpenSSL 1.02. Isso quebrou o HTTP/2 de metade da web já que quase ninguém usava essa versão do OpenSSL. Só saiu no Ubuntu na versão 16.04 (abril de 2016), por exemplo. Então se você habilitou o HTTP/2 há alguns meses atrás da uma conferida pra ver se não quebrou no Chrome.</p></li><li><p>Colocar o site inteiro para responder apenas em HTTPS é bacana em alguns pontos. O Google te dá mais relevância, você torna a navegação do seu usuário mais segura, mas você perde um tempo adicional na validação do certificado. Isso precisa ser levado em conta quando analisamos a performance do site.</p></li></ul><h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><p>Você não altera o seu CSS ou as imagens do seu site a cada segundo correto? Então pode se dar ao luxo de colocar um tempo limite de cache. Isso permite que o seu usuário não carregue o mesmo recurso duas vezes enquanto navega no seu site ou quando retornar no dia seguinte.</p><p>Eu optei por colocar um cache <em>infinito</em> (2 anos) e trabalhar a expiração dele pela versão. Toda vez que faço um deploy eu adiciono a data <em>(YYYYMMDDHHmm)</em> com precisão de minutos numa querystring no nome do arquivo. Isso força o browser a carregar a nova versão.</p><p>Para o browser <em>cachorro.png</em> é um arquivo diferente de <em>cachorro.png?v=2</em>. O que faz total sentido já que em alguns casos a querystring faz parte de um processo para que a imagem ou arquivo seja gerado. Quem nunca viu um <em>batata.jpg?width=200&amp;height=200&amp;quality=medium</em>?</p><h3 id="Gzip"><a href="#Gzip" class="headerlink" title="Gzip"></a>Gzip</h3><p>Sim.</p><p>Ahhh, mas não precisa habilitar para imagens não. Só para HTML, CSS e JS. Em tese você já otimizou o suficiente as suas imagens e a compactação do Gzip não faria diferença nenhuma. Só aumentaria o tempo do servidor para compactar e do browser para descompactar.</p><h2 id="O-que-falta-otimizar"><a href="#O-que-falta-otimizar" class="headerlink" title="O que falta otimizar"></a>O que falta otimizar</h2><ul><li><p>Servir as imagens dos posts em tamanhos diferentes para devices diferentes. Já faz tempo que os browsers suportam nativamente isso, mas falta tempo para criar um processo que automatize esse processo.</p></li><li><p>Adicionar um processo de minificação de imagens mais eficiente (a comunidade do Hexo anda meio paradona, mas to futicando aqui).</p></li><li><p>Achar algum host decente no Brasil. A Digital Ocean é um amor, mas perco muito tempo por conta da latência. Brasil x USA não é tão perto assim. É de longe meu maior gargalo hoje.</p></li></ul><p>E a gente fica por aqui. São otimizações simples, mas se você trabalha em agência ou tem alguns clientes onde um gerador de estáticos resolveria da para otimizar bem o carregamento com essas dicas.</p><p>Também tive resultados interessantes com dois sites em Wordpress nesse mesmo servidor usando NGINX em conjunto com o plugin <a href="https://www.w3-edge.com/products/w3-total-cache/" target="_blank" rel="external">W3 Total Cache</a>.</p></div></div><footer><section id="author-post" itemprop="author" itemscope itemtype="http://schema.org/Person"><div class="inner"><img itemprop="image" src="/images/author.jpg" class="author-picture"><div class="author-details"><h2 class="author-name" itemprop="name">Leandro Oriente</h2><p class="author-work" itemprop="jobTitle">Desenvolvedor Front End</p></div></div></section></footer></article><nav id="article-nav"><div class="inner"><div class="article-nav-link-wrap"><a href="/o-que-e-uber-e-como-andar-de-graca/" id="article-nav-older"><strong class="article-nav-caption">Anterior</strong><div class="article-nav-title">O que é Uber e como ganhar uma viagem grátis</div></a></div><div class="article-nav-link-wrap"></div></div></nav><section id="comments"><div class="inner"><h2>Comentários</h2><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div><script>var disqus_shortname = 'leandrooriente';
  var disqus_url = 'https://leandrooriente.com/criando-sites-estaticos-extremamente-performaticos/';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();</script></section></section><footer id="footer"><div class="inner"><p>&copy; 2016 Leandro Oriente, Desenvolvedor Front End</p><p class="footer-contact"><a href="https://github.com/leandrooriente/">Github</a> - <a href="https://www.linkedin.com/in/leandrooriente">Linkedin</a> - <a href="/rss2.xml">RSS</a></p></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-25340215-1', 'auto');
ga('send', 'pageview');</script></body>