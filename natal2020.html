<!DOCTYPE html>
<html lang="en">

<head>
    <title class="next-head">Natal 2020</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./style-natal.css" />
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Mountains+of+Christmas|Cutive+Mono|Open+Sans|Orbitron">
</head>

<body>
    <div class='failed' id='failed'>
        <div class="failed-content">
            <h1>
                FAILED    
            </h1>
            <img src="./fail.gif" />
        </div>
    </div>
    <div id="main">
        <div id="header" class="header">
            <h1>Desafio surpresa!</h1>
            <div class="instructions">
                <p>Cada um dos três desafios desbloqueia uma foto de Natal.</p>
                <p>Procure dicas nas fotos para descobrir onde achar o seu presente!</p>
        
                <p>Essa página vai se autodestruir em 3 minutos!</p>
                <button id="start">Começar</button>
            </div>
        </div>

        <div id="challenges" class="challenge-wrapper">
            <p class="timer" id="timer">03:00</p>
            <div class="photo">
                <div id="challenge1" class="challenge">
                    <label>
                        <span>Qual é o meu jogo de video game favorito?</span>
                        <input id='input1' type="text" />
                    </label>
                </div>
                <img src='/photo1.jpg' />
            </div>

            <div class="photo">
                <div id="challenge2" class="challenge">
                    <label>
                        <span>Se eu fosse comprar um carro, de qual marca seria?</span>
                        <input id='input2' type="text" />
                    </label>
                </div>
                <img src='/photo2.jpg' />
            </div>

            <div class="photo">
                <div id="challenge3" class="challenge">
                    <label>
                        <span>Com quantos anos eu vou me aposentar?</span>
                        <input id='input3' type="number" />
                    </label>
                </div>
                <img src='/photo3.jpg' />
            </div>
        </div>
    </div>

    <script>
        const niceAudio = new Audio('./nice.mp3');
        const hasFailed = localStorage.getItem('failed');

        const failed = () => {
            localStorage.setItem('failed', true);
            window.location.reload();
        }

        if (hasFailed) {
            document.querySelector('#failed').classList.add('show');
        }

        let clockAudio;
        let interval;
        function startTimer(duration, display) {
            let timer = duration, minutes, seconds;
            interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    timer = 0;
                    clearInterval(interval);
                    failed();
                }
            }, 1000);
        }
        
        const playTiger = () => {
            const audio = new Audio('./cathiss.mp3');
            audio.play();
        };

        const correctAnswers = [false, false, false];
        const checkAnswers = () => {
            const isFinished = !correctAnswers.some(answer => answer === false);

            if (isFinished) {
                clockAudio.pause();
                playTiger();
                clearInterval(interval);
            } else {
                niceAudio.play();
            }
        }

        const start = () => {
            clockAudio = new Audio('./clock.mp3');
            clockAudio.play();

            document.querySelector('#challenges').classList.add('show');

            const time = 60 * 3,
                display = document.querySelector('#timer');
            startTimer(time, display);
        };

        document.querySelector('#start').addEventListener('click', start);

        document.querySelector('#input1').addEventListener('keyup', (event) => {
            const acceptableAnswers = [
                'dark souls',
                'darksouls',
                'bloodborne',
            ];

            if (typeof event.target.value === 'string' && acceptableAnswers.find(answer => answer === event.target.value.toLowerCase())) {
                correctAnswers[0] = true;
                document.querySelector('#challenge1').remove();
                checkAnswers();
            }
        });

        document.querySelector('#input2').addEventListener('keyup', (event) => {
            if (typeof event.target.value === 'string' && event.target.value.toLowerCase().indexOf('tesla') !== -1) {
                correctAnswers[1] = true;
                document.querySelector('#challenge2').remove();
                checkAnswers();
            }
        });

        document.querySelector('#input3').addEventListener('keyup', (event) => {
            if (typeof event.target.value === 'string' && event.target.value.trim() === '35') {
                correctAnswers[2] = true;
                document.querySelector('#challenge3').remove();
                checkAnswers();
            }
        })
    </script>
</body>

</html>